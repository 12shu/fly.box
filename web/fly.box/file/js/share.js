!function () { var _ = fly; window.indexPath = "../"; var A = { Download: 1, Upload: 4, IsPublic: 16, ByLogin: 64, ByPassword: 256, ToPerson: 1024, NoDir: 4096, CanDir: 8192, MustDir: 16384 }, $ = { 1: "\u5141\u8bb8\u4e0b\u8f7d", 4: "\u5141\u8bb8\u4e0a\u4f20", 16: "\u516c\u5f00\u5206\u4eab", 64: "\u5fc5\u987b\u767b\u5f55", 256: "\u79c1\u5bc6\u5206\u4eab", 1024: "\u5206\u4eab\u7ed9Ta\u4eec", 4096: "\u4e0d\u80fd\u521b\u5efa\u6587\u4ef6\u5939", 8192: "\u53ef\u521b\u5efa\u6587\u4ef6\u5939", 16384: "\u5fc5\u987b\u521b\u5efa\u6587\u4ef6\u5939" }; fly.box.Share = _.Class({ constructor: function () { var $ = this; _(function () { $.createMembers(); $.getFiles(); $.initEvents() }) }, by: _.getQuery("by"), createMembers: function () { this.fileList = _("#field-list span"); this.needLoginBox = _("#need-login"); this.sharePowerBlock = _("#share-power-block"); this.sharePowerInputs = _("#share-power-block input"); this.sharePowerLabels = _("#share-power-block label"); this.uploadPassword = _("#upload-password"); this.downPassword = _("#down-password"); this.fetchPassword = _("#fetch-password"); this.shareTitle = _("#share-title"); this.weiboIframe = _("#share-weibo-block iframe"); this.sendByQQMail = _(".send-by-qqmail"); this.chkAllowDown = _("#can-down") }, initEvents: function () { var $ = this; this.sharePowerInputs.change(function () { $.setSharePowerStyle(); $.savePower() }); this.shareTitle.click(function () { this.contentEditable = true; this.className = "focus-box"; this.focus() }); this.shareTitle.onBlur(function () { var A = _(this).text(); _.post(_.box.ajaxUrl("ShareTo", "rename"), { ids: $.share.id, name: A }, function (B) { B.msg && alert(B.msg); if (B.success) { $.shareTitle[0].contentEditable = false; $.shareTitle[0].className = ""; _.common.showMessage("\u5df2\u5c06\u6807\u9898\u4fee\u6539\u4e3a\u201c{0}\u201d".format(A), 10000) } }) }) }, loadShares: function () { if (this.by) return; var A = this, $ = this.files.select("o=>o.id").join(); _.post({ url: _.box.ajaxUrl("Share", "GetShares"), data: { "file-ids": $ }, loading: { css: "f-loading", box: _("#shares-block") }, success: function ($) { if ($.success) A.showShares($.data) } }) }, showShares: function ($) { if (!$.length) return; var A = _("#list-template").html(); A = "{@for o as share}\n" + A + "\n{for@}"; var B = A.format($); _("#share-list-wrap").html("<table id=share-list>{0}</table>".format(B)); _("#shared-count-tip").html("\u8fd9\u4e9b\u6587\u4ef6\u5df2\u88ab\u5206\u4eab\u8fc7 <b>{0}</b> \u6b21\uff0c\u5efa\u8bae\u4f7f\u7528\u5df2\u521b\u5efa\u597d\u7684\u5206\u4eab\uff1a".format($.length)) }, getPowerNames: function (B) { var A = []; _.each($, function ($, _) { if ((B & _) == _ && !$.contains("\u4e0d")) A.push($) }); return A.join("\u3001") }, setSharePowerStyle: function () { var $ = this; this.sharePowerInputs.each(function (A, B) { _($.sharePowerLabels[B])[A.checked ? "addClass" : "removeClass"]("yes"); if (A.type == "radio") { if (A.checked) _(A.parentNode)[A.id.startWith("no-") ? "removeClass" : "addClass"]("can") } else _(A.parentNode)[A.checked ? "addClass" : "removeClass"]("can") }) }, supperCopy: function () { var A = this; if (_.box.isPC) _("#copy-link").click(function () { var $ = "{url}#\r\n{title}"; if (A.share.fetchPassword) $ += "\r\n\u5206\u4eab\u5bc6\u7801\uff1a{fetchPassword}"; $ = $.format(A.share); evalPC('var clipboard = flyBox.common.gui.Clipboard.get();clipboard.set(args.text, "text");args.cb()', { text: $, cb: function () { _.common.showMessage("\u5206\u4eab\u94fe\u63a5{0}\u5df2\u590d\u5236\u3002".format(page.share.fetchPassword ? "\u548c\u5bc6\u7801" : "")) } }) }); else { ZeroClipboard.setMoviePath("../../fly.common/zeroClipboard/ZeroClipboard.swf"); var $ = this.clip = new ZeroClipboard.Client(); $.setHandCursor(true); $.addEventListener("mouseOver", function (B) { var _ = "{url}#\r\n{title}"; if (A.share.fetchPassword) _ += "\r\n\u5206\u4eab\u5bc6\u7801\uff1a{fetchPassword}"; _ = _.format(A.share); $.setText(_) }); $.addEventListener("complete", function (A, $) { _.common.showMessage("\u5206\u4eab\u94fe\u63a5{0}\u5df2\u590d\u5236\u3002".format(page.share.fetchPassword ? "\u548c\u5bc6\u7801" : "")) }); setTimeout(function () { $.glue("copy-link"); $.div.className = "copy-link-swf-wrap" }, 500) } }, createLink: function ($) { var A = this.getFileIds(); if (!A) return false; var B = this; frameElement.shared = true; _.post({ url: fly.box.ajaxUrl("Share", "CreateShareLink"), data: { type: B.shareType, allowUpload: B.allowUpload, "file-ids": A }, loading: { css: "f-loading", box: _(".ajax-loading") }, success: function ($) { $.msg && alert($.msg); if (!$.success) return; B.bindShare($.data) } }) }, bindShare: function (A) { this.supperCopy(); this.share = A; A.url = _.toAbsUrl(A.url); this.showShareBlock(); this.setPower(); if (A.targetCount) { var B = _("#btn-show-send-users"); B.html(B.html() + " <span title='\u5df2\u5206\u4eab\u7ed9{0}\u4e2a\u7528\u6237'>({0})</span>".format(A.targetCount)) } _("#share-link").val(A.url); this.shareTitle.text(A.title); this.fetchPassword.val(A.fetchPassword); var $ = A.random.substr(0, 4); this.downPassword.val(A.fetchPassword || A.uploadPassword || $); this.uploadPassword.val(A.uploadPassword || A.fetchPassword || $); var C = "../../fly.common/share/to.htm?url={0}&summary={1}".format(encodeURIComponent(this.share.url), ""); this.weiboIframe.attr("src", C); this.onPowerChange(); if (this.by == "User") this.notifyBySystem(); else if (this.by == "Mail") this.notifyByMail() }, setQQMailLink: function () { var A = { url: this.share.url, to: "qqmail", desc: "", summary: this.share.shareTitle, title: "{0}\u5206\u4eab{title}".format(_.box.getUserContext(null, false).user.name, this.share), site: this.share.url, pics: "" }, $ = []; for (var B in A) $.push(B + "=" + encodeURIComponent(A[B] || "")); this.sendByQQMail.attr("href", "http://mail.qq.com/cgi-bin/qm_share?" + $.join("&")) }, onPowerChange: function () { _("#open-share-link").attr("href", this.share.url + (this.share.fetchPassword ? "#\u5206\u4eab\u5bc6\u7801:" + this.share.fetchPassword : "")); var B = []; if (this.share.fetchPassword) B.push("\u5206\u4eab\u5bc6\u7801\u662f\u201c{fetchPassword}\u201d "); var A = "Hi\uff0c\u6211\u7ed9\u5927\u5bb6\u5206\u4eab\u4e86\u201c{title}\u201d\uff0c" + (B[0] ? B.join("\uff0c") + "\u54e6\uff01" : "") + "\u5feb\u6765\u770b\u770b\u5427~"; this.share.shareTitle = A.format(this.share); this.weiboIframe[0].shareTitle = this.share.shareTitle; try { this.weiboIframe[0].contentWindow.reset() } catch ($) { } this.setQQMailLink() }, savePower: function () { var C = this; if (!_("#can-down")[0].checked && !_("#can-upload")[0].checked) { _.common.showMessage(); alert("\u8bbe\u7f6e\u6709\u8bef\uff0c\u5fc5\u987b\u5141\u8bb8\u4e0b\u8f7d\u6216\u4e0a\u4f20\uff01"); C.setPower(); return } var $ = { id: C.share.id }, B = C.shareType == "public" ? A.IsPublic : (C.shareType == "private" ? A.ByPassword : A.ToPerson), E = []; this.sharePowerInputs.each(function ($, D) { if ($.checked) { if ($.id.contains("no-")) return; B = B | parseInt($.value); var A = (_($).attr("msg") || _(C.sharePowerLabels[D]).text()).replace("\uff1f", ""); E.push(" &nbsp; &nbsp; " + A) } }); E = "\u5df2\u8bbe\u7f6e\u8be5\u5206\u4eab\uff1a<br/>" + E.join("<br/>"); if (this.allowUpload) { B = B | (this.chkAllowDown[0].checked ? A.AllowDown : A.NoDown); if (this.chkAllowDown[0].checked) E = E.replace(/\u53ef\u4e0a\u4f20/g, "\u53ef\u4e0a\u4f20\u3001\u4e0b\u8f7d") } $.power = B; var D = this.checked; _.post(_.box.ajaxUrl("Share", "SetPower"), $, function ($) { $.msg && alert($.msg); if ($.success) { C.share.power = B; C.onPowerChange(); _.common.showMessage(E, 10000) } else C.setPower() }) }, setPower: function () { var $ = this; this.sharePowerInputs.each(function () { var _ = parseInt(this.value); if (($.share.power & _) == _) this.checked = true; else this.checked = false }); this.setSharePowerStyle() }, showShareBlock: function () { fly.getBody().addClass("show-share-to share-" + this.shareType); if (this.allowUpload) fly.getBody().addClass("can-upload") }, toPublic: function () { this.shareType = "public"; this.createLink(function () { }) }, toPrivate: function () { this.shareType = "private"; this.createLink(function () { }) }, toPerson: function () { this.shareType = "to-person"; this.createLink(function () { }) }, toUpload: function () { this.createLink(function () { }) }, loadShare: function () { if (!this.fetchCode) return false; var $ = this; frameElement.shared = true; _.post({ url: fly.box.ajaxUrl("Share", "GetById"), data: { code: this.fetchCode }, loading: { css: "f-loading", box: _(".ajax-loading") }, success: function (_) { _.msg && alert(_.msg); if (!_.success) return; $.shareType = _.type; $.allowUpload = (_.data.power & A.NoUpload) != A.NoUpload; $.files = _.files; $.showFiles(); $.bindShare(_.data) } }) }, showSelectUserCount: function ($, _) { if (_) $ = (this.oldUserCount || 0) + _; this.oldUserCount = $; if (!this.sendToUserButton.oldHtml) this.sendToUserButton.oldHtml = this.sendToUserButton.html(); this.sendToUserButton.html(this.sendToUserButton.oldHtml + ' <span title="\u5c06\u5206\u4eab\u7ed9{0}\u4e2a\u7528\u6237">({0})</span>'.format($)) }, notifyBySystem: function () { if (this.userEditor) this.userEditor.deleteAll(); else { this.sendToUserButton = _("#btn-send-to-users"); this.userEditor = new fly.ui.TagsEditor({ id: "user_editor", tags: [], onExists: function () { return false } }); this.userEditor.onAddTag(function () { page.showSelectUserCount(null, 1) }); this.userEditor.onDeleteTag(function () { page.showSelectUserCount(null, -1) }) } this.oldUserCount = 0; fly.getBody().addClass("share-by-users"); _.post(_.box.ajaxUrl("Share", "GetTargets"), { id: this.share.id }, function ($) { if ($.success) { page.userEditor.addTags($.data); page.createUserSelectFrame() } else alert("\u83b7\u53d6\u63a5\u6536\u8005\u9519\u8bef\u3002") }) }, createUserSelectFrame: function () { if (this.frameSelectUser) { this.frameSelectUser[0].src += ""; return } var B = this; this.frameSelectUser = _('<iframe id="target-frame" src="../../fly.base/user/tree.htm?&supper-search=1&supper-role=1&async=0" frameborder=0 scrolling=no style="" allowTransparency=1  width="100%"></iframe>'); _("#user-select-box").append(this.frameSelectUser); var $ = false, A = this.frameSelectUser[0]; A.onCheck = function (C, _) { if (!$ || C.type != "user") return; var A = { id: C.id, name: C.text }; if (C.checked) B.userEditor.addTag(A); else B.userEditor.deleteTag(A) }; A.onExpand = function (A, E) { var C = (A.text || "").contains("\u641c\u7d22"); if (!E && !C) return; if (C) $ = false; var _ = B.userEditor.getTags(); function D($) { $.each(function ($) { $.check(_.any(function (_) { return _.id == $.id })); D($.items) }) } D(A.items); if (C) $ = true }; A.onRequestData = function (_) { setTimeout(function () { A.onExpand(_, true); $ = true }, 100) } }, closeSendUserBox: function () { fly.getBody().removeClass("share-by-users") }, sendToUsers: function () { var $ = this.userEditor.getTags().select("o=>o.id").join(","); if (!$) { alert("\u8bf7\u9009\u62e9\u63a5\u6536\u7528\u6237\u3002"); return } _.post(_.box.ajaxUrl("Share", "SendToUsers"), { id: this.share.id, users: $ }, function ($) { if ($.success) { page.closeSendUserBox(); _.common.showMessage("\u5df2\u5206\u4eab\u7ed9{0}\u4e2a\u7528\u6237\u3002".format($.data)) } else alert($.msg || "\u53d1\u9001\u5931\u8d25\u3002") }) }, notifyBySMS: function () { var $ = "\u4f60\u597d\uff01\u4f60\u7684\u670b\u53cb{0}\u7ed9\u4f60\u5206\u4eab\u6587\u4ef6\uff1a\r\n\xb7{title}\r\n\u5206\u4eab\u5730\u5740\uff1a{url}" + (this.share.fetchPassword ? "\r\n\u5206\u4eab\u5bc6\u7801\uff1a{fetchPassword}" : ""); $ = $.format(_.box.getUserContext(null, false).user.name, this.share); var A = _.toAbsUrl(indexPath + "common/form.htm?m=sms&form=edit&getTarget=share|{0}&content={1}".format(this.share.id, encodeURIComponent($))); fly.common.createDialog({ title: "\u53d1\u9001\u77ed\u4fe1", url: A, width: 900, height: 500, resizeable: false, hideOnClose: false }, function ($) { $.show(true) }, _.myTop()) }, notifyByMail: function () { if (this.mailEditor) this.mailEditor.deleteAll(); else { var A = /^([0-9a-z]+[-._+&])*[0-9a-z]+@([-0-9a-z]+[.])+[a-z]{2,6}$/i; this.mailEditor = new fly.ui.TagsEditor({ id: "mail_editor", onAddByInput: function ($) { if (A.test($)) return $; _.common.showMessage("\u4e0d\u6b63\u786e\u7684\u90ae\u4ef6\u5730\u5740\u3002"); return false } }) } fly.getBody().addClass("share-by-mail"); var $ = "\u4e3b\u9898\uff1a{0}\u5206\u4eab\uff1a{title}\r\n\u4f60\u597d\uff01\u4f60\u7684\u670b\u53cb{0}\u7ed9\u4f60\u5206\u4eab\u6587\u4ef6\uff1a\r\n\r\n\xb7{title}\r\n\r\n\u5206\u4eab\u5730\u5740\uff1a{url}" + (this.share.fetchPassword ? "\r\n\u5206\u4eab\u5bc6\u7801\uff1a{fetchPassword}" : ""); $ = $.format(_.box.getUserContext(null, false).user.name, this.share); _("#mail-body").val($) }, closeSendMailBox: function () { fly.getBody().removeClass("share-by-mail") }, sendMail: function () { var C = this, A = this.mailEditor.getTags().join(";"), $ = _("#mail-body").val(); if (!A) return alert("\u8bf7\u8f93\u5165\u90ae\u7bb1\u5730\u5740\uff01"); var B; $ = $.replace(/^\s*\u4e3b\u9898[\uff1a:]([^\r\n]+)/, function (_, $) { B = $; return "" }); if (!$) return alert("\u90ae\u4ef6\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a\u3002"); if (!confirm("\u771f\u7684\u8981\u53d1\u9001\u5417\uff1f")) return; _("#share-send-mail>a").hide(); if (!B) B = "{0}\u5206\u4eab{title}".format(_.box.getUserContext(null, false).user.name, this.share); $ = $.replace(this.share.url, '<a target=_blank href="{0}">{0}</a>'.format(this.share.url)).replace(/(\r\n)|\r|\n/g, "<br/>"); _.post(_.box.ajaxUrl("Share", "SendNotifyMail"), { id: this.share.id, mails: A, subject: B, body: $ }, function ($) { _("#share-send-mail>a").show(); $.msg && alert($.msg); if (!$.success) return; _.common.showMessage("\u90ae\u4ef6\u5df2\u53d1\u9001\u3002"); C.closeSendMailBox() }) }, showFiles: function () { var $ = this.files.select(function ($) { return '<a id={id} title="{name}"><nobr>{name}</nobr><b title=\u5220\u9664 onclick="fly(this.parentNode).remove()">x</b></a>'.format($) }); this.fileList.html($.join(",")); if (!this.fetchCode) if (this.by == "User") this.toPerson(); else if (this.by == "Mail") this.toPrivate() }, getFiles: function () { var A = this; this.fetchCode = frameElement.fetchCode || _.getQuery("id"); if (this.fetchCode) { this.loadShare(); return } this.files = window.frameElement ? frameElement.shareFiles : null; if (this.files) { this.showFiles(); this.loadShares() } else { var $ = _.getQuery("file-ids"); if ($) _.post(fly.box.ajaxUrl("Share", "GetFileInfo"), { ids: $ }, function ($) { A.files = $.data; A.showFiles(); A.loadShares() }) } }, getFileIds: function (A) { var $ = this.fileList.$("a").select("o=>o.fileId||o.id").join(","); if (!$) { _.alert(A || "\u6ca1\u6709\u8981\u5206\u4eab\u7684\u6587\u4ef6\u3002"); return null } return $ }, unShare: function () { var $ = this.getFileIds("\u6ca1\u6709\u8981\u53d6\u6d88\u5206\u4eab\u7684\u6587\u4ef6\u3002"); window.frameElement.unShare = true; window.frameElement.unShareFiles = $; window.frameElement.dialog.close() } }); window.page = new fly.box.Share(); window.submit = function ($) { return page.submit($) } } ()