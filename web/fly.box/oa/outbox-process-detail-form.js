!function ($) { $ = fly; window.indexPath = "../"; $.doc.addClass("outbox-process"); $.doc.addClass("p-work-process-detail p-work"); $.box.OutboxProcessDetailForm = $.Class({ name: "\u4e8b\u52a1", title: "\u4e8b\u52a1\u529e\u7406\u8be6\u60c5", base: $.box.FormBase, getModelUrl: $.base.ajaxUrl("work", "WorkProcessDetail"), buttons: [], pageFormat: ['<div id=top-empty></div><div id="title-block"><a name=top>{title}</a></div>', "<a id=to-process href=#process class=button-32 >\u529e\u7406\u8be6\u60c5</a>", '<a id=to-top href="#top" class=button-32 ></a>', '<a id=btn-return href="list.htm?m=oa&list=outbox" class=button-32 >\u8fd4\u56de</a>', '<form id="content-block" class="oa-process-form" method="post"></form>', "<a name=process class=process-detail-label >\u529e\u7406\u8be6\u60c5\uff1a</a>", '<div id="targets"></div><br/>'].join(""), targetItemFormat: '<li id="target-{id}" class="target-process {css}" >' + '<div class=target-info targetId="{id}">' + "<i class=target-ico ></i>" + '<span class=target-state >{completeTime?"\u5df2\u529e\u7406":(receiveTime?"\u5df2\u63a5\u6536":"\u672a\u63a5\u6536")}</span>' + "{@if completeTime||receiveTime}" + " <span class=target-time>{(completeTime||receiveTime).format($.box.dt2Format)}</span>" + "{if@}" + ' <a href="javascript:" onclick="page.loadMoreSummary(\'{id}\');return false"><span class=target-user >#{user}</span> &nbsp; \u66f4\u591a{commentCounts?"("+commentCounts+")":"..."}</a> ' + "</div>" + "{@if lastSummary}" + '<div id="target-summary-{id}" class="target-summary-one">' + "<div class=summary-infos ><a class=time >{lastSummary.time.format($.box.dt2Format)}</a> \u2192 <a class=user-name >{lastSummary.user}</a></div>" + "<div class=summary-content >{lastSummary.content}</div>" + "</div>" + "{if@}" + '<div id="summary-more-{id}" class=summary-more ></div>' + "</li>", createMembers: function () { this.dWin = window.parent || window; this.indexPath = this.dWin.indexPath || ""; this.$base.createMembers.apply(this, arguments) }, afterCreateForm: function () { var _ = this; this.$base.afterCreateForm.apply(this, arguments); this.attachmentsBox = $("#attachments"); this.contentBox = $("#content"); this.summaryBox = $("#summary"); this.targetsBox = $("#targets"); this.showAttachments(); this.showTargets(); this.showContent() }, showContent: function () { var A = this; if (this.model.content.startWith("FILE:")) { var _ = this.model.content.substr(5).split(","); this.contentBox.addClass("oa-content-file").html('<iframe src="../file/open-doc.htm?show-list=0&id={0}&name={1}" class="oa-content-frame" frameborder=0 scrolling=no allowTransparency=1></iframe>'.format(_[0], _[1])) } else this.contentBox.addClass("oa-content-text").text(this.model.content); var B = 0, C = setInterval(function () { if (B++ > 8) clearInterval(C); if (Math.max(document.documentElement.scrollHeight, document.body.scrollHeight) > 900) { $("#to-top,#to-process").fadeIn(); clearInterval(C) } }, 2000) }, showAttachments: function () { var A = this.getModelResult.attachments; if (A && A[0]) { var _ = A.select("o=>o.id").join(","), B = A.select(function (A) { return '<a href="../file/open-doc.htm?show-list=0&id={id}&name={name}&ids={1}" target=_blank  title="{name} ({0})">{name}</a>'.format($.sizeFormat(A.size), _, A) }).join(""); this.attachmentsBox.html(B) } else this.attachmentsBox.parent().hide() }, showTargets: function () { var $ = this.targetItemFormat, _ = this.getModelResult.targets.select(function (_) { _.css = _.isBold ? "target-has-new" : ""; return $.format(_) }).join(" "); this.targetsBox.append(_) }, loadMoreSummary: function (C, A) { var _ = $("#target-" + C); _.toggleClass("target-summary-more"); var B = this["page_" + C]; if (!B) { B = this["page_" + C] = new $.box.WorkTargetComment(); B.cssContainer = _; B.render($("#summary-more-" + C)); B.getPageDataFilters = commentPage.postArgs = { infoId: C, type: "WorkTarget" }; B.loadPageData("last") } } }); ["../../fly.common/fly.ui/plugins/themes/plain/simple-pager.css?" + $.pathPart, "../themes/box-default/comment.css?" + $.pathPart, "../themes/box-default/oa/css.css?" + $.pathPart].each($.Style.loadCss); $.loadScript("../../fly.common/fly.ui/plugins/pager/simple.js?" + $.pathPart, function () { $.loadScript("../comment/comment.js?" + $.pathPart, function () { $.box.WorkTargetComment = $.Class({ base: $.box.Comment, noCommentContent: "", saveButtonText: "\u56de\u590d", saveUrl: $.box.ajaxUrl("work", "ReplyTarget"), beforeSave: function ($) { if (!$.content) if (!confirm("\u8bf7\u8f93\u5165\u56de\u590d\u5185\u5bb9\uff01")) { this.txtComment.focus(); return false } return true }, cancel: function () { location.href = "list.htm?m=oa&list=outbox" } }); window.page = new $.box.OutboxProcessDetailForm(); page.show() }) }) } ()