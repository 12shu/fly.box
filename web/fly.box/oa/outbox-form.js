!function ($) { $ = fly; window.indexPath = "../"; $.box.OutboxForm = $.Class({ name: "\u4e8b\u52a1", title: "\u65b0\u5efa\u901a\u77e5\u3001\u516c\u544a", base: $.box.FormBase, getModelUrl: $.base.ajaxUrl("work", "GetById"), buttons: ['<a onclick="page.save();return false">\u4fdd\u5b58</a>', '<a href="list.htm?m=oa&list=outbox">\u8fd4\u56de</a>'], pageFormat: ['<div id=top-empty></div><div id="title-block">{title}</div>', '<div id="toolbar" class=button-32  ></div>', '<form id="content-block" class="oa-view-form" method="post"></form>'].join(""), save: function () { var _ = this.getSubmitValues(); if (!_) return; if (this.attachments) _.attachments = this.attachments.select('o=>o.id+","+o.name').join("|"); if (this.contentFile) _.content = "FILE:" + this.contentFile.id + "," + this.contentFile.name; _.id = this.modelId; $.post($.box.ajaxUrl("work", "SaveWork"), _, function (_) { _.msg && $.alert(_.msg); if (_.success && _.data) { alert("\u4e8b\u52a1\u5df2\u6210\u529f\u4fdd\u5b58\u3002"); window.open("form.htm?m=oa&form=outbox-assign-form&id=" + _.data, "_self") } }, $.common.onAjaxErr) }, createMembers: function () { this.dWin = window.parent || window; this.indexPath = this.dWin.indexPath || ""; this.$base.createMembers.apply(this, arguments) }, afterCreateForm: function () { var A = this; this.$base.afterCreateForm.apply(this, arguments); this.selectContentButton = $("#select-content"); this.contentBox = $("#content"); this.attachments = (this.model || {}).attachments; this.attachmentsBox = new fly.ui.TagsEditor({ id: "attachments", tags: this.attachments, onExists: function () { return false } }); this.contentFileBox = new fly.ui.TagsEditor({ id: "content-file", onExists: function () { return false } }); this.contentFileBox.onDeleteTag(function () { page.setContentFile(null) }); var B = this.contentBox.data("validateItem"), _ = B.validate; B.validate = function () { if (A.contentFile) return null; return _.apply(this, arguments) }; this.checkConent() }, checkConent: function () { var _ = this.contentBox.val(); if (_.startWith("FILE:")) { this.contentBox.val(""); var B = _.substr(5).split(",", 2), $ = B[0], A = B[1], C = "../file/open-doc.htm?show-list=0&id={0}&name={1}".format($, A); this.setContentFile({ id: B[0], text: A, name: A, url: C }) } }, showAttachmentsList: function () { var $ = this; $.attachmentsBox.addTags(this.attachments) }, setContentFile: function ($) { if ($) { this.contentFileBox.deleteAll(); this.contentFileBox.addTag($); this.contentBox.disable() } else this.contentBox.enable(); this.contentFile = $ }, selectContentFile: function () { this.openSelectDialog({ title: "\u9009\u62e9/\u4e0a\u4f20\u6b63\u6587\u5185\u5bb9\uff08\u9650\u6587\u6863\uff09", multi: 0, onSelect: function ($) { page.setContentFile($) } }) }, selectAttachments: function () { this.openSelectDialog({ title: "\u9009\u62e9/\u4e0a\u4f20\u9644\u4ef6", multi: 1, onSelect: function ($) { page.attachments = (page.attachments || []).merge($); page.showAttachmentsList() } }) }, openSelectDialog: function (_) { var A = this; this.dWin.fly.common.createDialog({ id: "selectDialog", title: _.title, url: this.indexPath + "file/manage.htm", width: 800, height: 450, resizeable: true, hideOnClose: false }, function (E) { E.show(); var C = ['<form style="display:inline" disabledrag=1 >', '<input name=key style="height:20px;margin:0px 5px 0px 300px;vertical-align:middle;border:1px solid #DDDDDD" />', '<a href=# class=a-btn-search style="display:inline-block;width:18px; height:18px;vertical-align:middle;background:url({0}themes/box-default/imgs/icons/search.png)"></a>&nbsp;&nbsp;&nbsp;', '<a href=# class="a-btn-ok f-sbtn" style="line-height:20px">\u786e\u5b9a</a>&nbsp;', '<a href=# class="a-btn-cancel f-sbtn" style="line-height:20px">\u8fd4\u56de</a>', "</form>"]; C = C.join("").format(A.indexPath); var F = $(C), D = E.titleBar.$(".f-dialog-title-buttons"); D.$(">").hide(); D.addClass("search-bar").append(F); function B() { E.iframeElement[0].contentWindow.search(F[0].key.value.trim()); return false } F.submit(B); F.$(".a-btn-search").click(B); F.$(".a-btn-ok").click(function () { var B = E.iframeElement[0].contentWindow.manager, A = B.getSelectFiles("\u8bf7\u9009\u62e9\u3002", _.multi ? null : "\u6b63\u6587\u5185\u5bb9\u53ea\u80fd\u9009\u62e9\u4e00\u4e2a\u6587\u6863\u6587\u4ef6\u3002").select(function (_) { var A = "../file/open-doc.htm?show-list=0&id={0}&name={1}".format(_.id, _.name); return { id: _.id, text: "{0}({1})".format(_.name, $.sizeFormat(_.size)), name: _.name, size: _.size, url: A} }); if (!A[0]) return; B.selectionModel.clearSelections(); _.onSelect(_.multi ? A : A[0]); if (_.multi) $.common.showMessage("\u6dfb\u52a0\u4e86{0}\u4e2a\u6587\u4ef6\uff0c\u53ef\u7ee7\u7eed\u6dfb\u52a0\u3002".format(A.length)); else E.close() }); F.$(".a-btn-cancel").click(function () { E.close() }) }) } }); ["../themes/box-default/oa/css.css?" + $.pathPart, "../../fly.common/fly.ui/plugins/themes/gray/tags-editor.css?" + $.pathPart].each($.Style.loadCss); $.loadScript("../../fly.common/fly.ui/plugins/input/empty-box.js?" + $.pathPart, function () { $.loadScript("../../fly.common/fly.ui/plugins/input/tags-editor.js?" + $.pathPart, function () { window.page = new $.box.OutboxForm(); page.show() }) }) } ()