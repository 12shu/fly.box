window.indexPath = "../../"; !function () { var A = fly; fly.mini.ajax = A.ajax; var C = !!window.frameElement, B = A.getQuery("async") != "0", _ = A("#tree-container"), E = new fly.mini.Tree({ container: _[0], selectionMode: fly.mini.selectionMode.none, checkMode: fly.mini.checkMode.multi, checkCascade: { check: { parent: 0, children: true }, uncheck: { parent: 0, children: true} }, autoScroll: true, showBorder: false, itemKey: "id", navTarget: "iframe", itemEvents: { panel: { click: function ($) { if ($.leaf) $.toggleCheck(); else $.toggle() } } }, onCheck: function (_, $) { if (C && frameElement.onCheck) frameElement.onCheck(_, $) }, onExpand: function ($) { if (C && frameElement.onExpand) frameElement.onExpand($) }, onJoin: function ($) { $.text = $.name + ($.phone ? "-" + $.phone : "") + ($.orgName ? "-" + $.orgName : ""); $.iconCss = "tree-node-" + $.type; $.leaf = $.type == "user" || $.type == "search" }, onRequestData: function (_, $) { if (C && frameElement.onRequestData) frameElement.onRequestData(_, $); if (!$.success) return []; if ($.userCount) $.data[0].name += "(" + $.userCount + ")"; if (!B && $.data[0]) $.data[0].expanded = true; return $.data }, async: { url: A.base.ajaxUrl("base", B ? "UserTree" : "AllUserTree", "id={id}&type={type}"), data: { role: A.getQuery("roleName") }, method: "post"} }), D = null; function J() { if (D) return; D = E.root.insertItem(0, { name: "\u641c\u7d22\u7ed3\u679c", type: "search", leaf: true, iconCss: "tree-node-search" })[0]; D.wrap.title = "Tab\u3001Enter\u9009\u4e2d\u7b2c\u4e00\u4e2a\u641c\u7d22\u7ed3\u6784\uff0c\u53ef\u7528\u4e0a\u4e0b\u952e\u9009\u62e9\u5176\u4ed6\uff0c\u8fd8\u53ef\u4ee5\u914d\u5408Shift\u591a\u9009\u54e6\u3002" } function $($) { J(); D.removeItem(D.items); D.currentIndex = -1; D.addItem($); if ($.length) D.expand(); D.setText("\u641c\u7d22\u7ed3\u679c({0})".format($.length)) } if (A.getQuery("supper-search") == "1") { var H = A("<input id=search-box class=search-input />"); A.getBody().prepend(H); new fly.ui.EmptyBox({ input: H, emptyValue: "\u641c\u7d22\uff1a\u59d3\u540d\u3001\u624b\u673a\u3001\u767b\u5f55\u540d\u3001\u90ae\u7bb1" }); var G = ""; H.keydown(function () { clearTimeout(this.searchHandler); this.searchHandler = setTimeout(function () { var _ = H.value().trim(); if (_ != G) { if (_) A.post(A.base.ajaxUrl("base", "Search"), { type: "user", key: _ }, function (_) { $(_.data) }); else $([]); G = _ } }, 1000); if ($event.keyCode == 9 || $event.keyCode == 13) I(); else if ($event.keyCode == 38) I(-1); else if ($event.keyCode == 40) I(1) }) } function I(B) { if (!D) return; A.Event.stop(true); if (B) { var _ = D.currentIndex; if (_ != -1 && !$event.shiftKey) D.items[_].check(false); _ += B; if (_ < 0) _ = D.items.length - 1; else if (_ >= D.items.length) _ = 0; D.currentIndex = _; D.items[_].check() } else { var $ = D.items[0]; if ($) $.toggleCheck() } } var F = function ($) { $ = $.order("name").order("DESC", "isPublic"); var B = $.select(function ($) { return '<option style="{isPublic?"color:red":""}">{name}</option>'.format($) }).join(""), _ = A('<select id=role-select class=role-select ><option value="">---- \u7528\u6237\u7ec4 ----</option>{0}</select>'.format(B)); A.getBody().prepend(_); _.change(function () { clearTimeout(this.roleChangeHandler); this.roleChangeHandler = setTimeout(function () { E.async.data.role = _.value().trim(); D = null; E.root.removeItem(E.root.items); E.root.collapse(); E.root.leaf = false; E.root.expand() }, 300) }) }; if (A.getQuery("supper-role") == "1") A.post(A.base.ajaxUrl("base", "RuleNames"), function ($) { if ($.success) F($.data) }); if (C && A.getQuery("auto-height") == "1") _.on("sizechange", function () { frameElement.style.height = (document.body.offsetHeight) + "px" }); else setTimeout(function () { var $ = _[0].offsetTop; _.height(document.documentElement.scrollHeight - $) }, 100) } ()